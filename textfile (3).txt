local Players = game:GetService("Players")
local ProximityPromptService = game:GetService("ProximityPromptService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local PathfindingService = game:GetService("PathfindingService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local PlotController = require(ReplicatedStorage.Controllers.PlotController)


local function RandomName()
    local chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
    return table.concat((function()
        local t = {}
        for i = 1, 8 do
            t[i] = chars:sub(math.random(#chars), math.random(#chars))
        end
        return t
    end)())
end


local screenGui = Instance.new("ScreenGui")
screenGui.Name = RandomName()
screenGui.ResetOnSpawn = false
screenGui.Parent = PlayerGui

local frame = Instance.new("Frame")
frame.Name = RandomName()
frame.Size = UDim2.new(0, 300, 0, 60)
frame.Position = UDim2.new(0.5, -150, 0.5, -30)
frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
frame.BorderSizePixel = 0
frame.AnchorPoint = Vector2.new(0.5, 0.5)
frame.Active = true
frame.Draggable = true
frame.Parent = screenGui

Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 12)

local stroke = Instance.new("UIStroke")
stroke.Color = Color3.fromRGB(0, 170, 255)
stroke.Thickness = 3
stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
stroke.Parent = frame

local hue = 0
RunService.RenderStepped:Connect(function()
    hue = (hue + 0.5) % 360
    frame.BackgroundColor3 = Color3.fromHSV(hue / 360, 0.6, 0.3)
end)

local label = Instance.new("TextLabel")
label.Name = RandomName()
label.Size = UDim2.new(0, 180, 0, 40)
label.Position = UDim2.new(0, 10, 0.5, -20)
label.BackgroundTransparency = 1
label.Text = "Alex Scripter's Auto Steal"
label.TextColor3 = Color3.fromRGB(255, 255, 255)
label.TextScaled = true
label.Font = Enum.Font.GothamBold
label.ZIndex = 1
label.Parent = frame


local toggle = Instance.new("TextButton")
toggle.Name = RandomName()
toggle.Size = UDim2.new(0, 60, 0, 30)
toggle.Position = UDim2.new(0, 200, 0.5, -15)
toggle.BackgroundColor3 = Color3.fromRGB(0, 170, 255) -- ON color
toggle.Text = ""
toggle.AutoButtonColor = false
toggle.BorderSizePixel = 0
toggle.ZIndex = 1
toggle.Parent = frame

Instance.new("UICorner", toggle).CornerRadius = UDim.new(0, 15)

local circle = Instance.new("Frame")
circle.Name = RandomName()
circle.Size = UDim2.new(0, 26, 0, 26)
circle.Position = UDim2.new(0, 32, 0, 2) -- ON
circle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
circle.BorderSizePixel = 0
circle.ZIndex = 2
circle.Parent = toggle

Instance.new("UICorner", circle).CornerRadius = UDim.new(1, 0)

local closeButton = Instance.new("TextButton")
closeButton.Name = RandomName()
closeButton.Size = UDim2.new(0, 24, 0, 24)
closeButton.Position = UDim2.new(1, -28, 0, 4)
closeButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
closeButton.Text = "X"
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.TextScaled = true
closeButton.Font = Enum.Font.GothamBold
closeButton.BorderSizePixel = 0
closeButton.ZIndex = 3
closeButton.Parent = frame

Instance.new("UICorner", closeButton).CornerRadius = UDim.new(0, 6)

closeButton.MouseButton1Click:Connect(function()
    screenGui:Destroy()
end)


local function MoveDirect(root, targetPos)
    local bv = Instance.new("BodyVelocity")
    bv.MaxForce = Vector3.new(1e6, 1e6, 1e6)
    bv.Velocity = Vector3.zero
    bv.Parent = root

    local conn
    conn = RunService.Heartbeat:Connect(function()
        if not bv.Parent then
            conn:Disconnect()
            return
        end

        local direction = targetPos - root.Position
        local dist = direction.Magnitude

        if dist < 5 then
            bv:Destroy()
            conn:Disconnect()
            LocalPlayer:Kick("You Successfully Stole!")
        else
            bv.Velocity = direction.Unit * 42
        end
    end)
end

local function MoveToBase(root, targetPos)
    local path = PathfindingService:CreatePath({
        AgentRadius = 2,
        AgentHeight = 5,
        AgentCanJump = true,
        AgentCanClimb = false
    })
    path:ComputeAsync(root.Position, targetPos)

    if path.Status ~= Enum.PathStatus.Success then
        return MoveDirect(root, targetPos)
    end

    local waypoints = path:GetWaypoints()
    local currentIndex = 1

    local bv = Instance.new("BodyVelocity")
    bv.MaxForce = Vector3.new(1e6, 1e6, 1e6)
    bv.Velocity = Vector3.zero
    bv.Parent = root

    local conn
    conn = RunService.Heartbeat:Connect(function()
        if not bv.Parent or currentIndex > #waypoints then
            bv:Destroy()
            conn:Disconnect()
            LocalPlayer:Kick("You Successfully Stole!")
            return
        end

        local wp = waypoints[currentIndex]
        local direction = wp.Position - root.Position
        local dist = direction.Magnitude

        if dist < 3 then
            currentIndex += 1
        else
            bv.Velocity = direction.Unit * 42
        end
    end)
end


local function TeleportToPlot()
    local character = LocalPlayer.Character
    if not character then return end
    local root = character:FindFirstChild("HumanoidRootPart")
    if not root then return end

    local myPlot = PlotController:GetMyPlot()
    if not myPlot or not myPlot.PlotModel then
        warn("❌ Could not get your plot")
        return
    end

    local base = myPlot.PlotModel
    local targetPos

    if base:FindFirstChild("TeleportPoint") and base.TeleportPoint:IsA("BasePart") then
        targetPos = base.TeleportPoint.Position
    elseif base.PrimaryPart then
        targetPos = base.PrimaryPart.Position
    else
        local total, count = Vector3.zero, 0
        for _, part in ipairs(base:GetDescendants()) do
            if part:IsA("BasePart") then
                total += part.Position
                count += 1
            end
        end
        targetPos = count > 0 and total / count or Vector3.new(0, 10, 0)
    end

    MoveToBase(root, targetPos)
end


ProximityPromptService.PromptButtonHoldBegan:Connect(function(prompt, playerWhoTriggered)
    if playerWhoTriggered ~= LocalPlayer then return end

    local promptHoldEnded = false
    prompt.PromptButtonHoldEnded:Once(function()
        promptHoldEnded = true
    end)

    task.wait(prompt.HoldDuration)
    if promptHoldEnded then return end

    TeleportToPlot()
end)